---
// src/pages/admin/users.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

// Auth from middleware
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

const { data: users, error } = await supabase
  .from("profiles")
  .select("id, email, full_name, role, is_active, created_at")
  .order("created_at", { ascending: false });
---

<AdminLayout title="Users">
  {error && <div class="alert error">{error.message}</div>}
  
  {users && users.length > 0 ? (
    <table class="admin-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Joined</th>
        </tr>
      </thead>
      <tbody>
        {users.map(user => (
          <tr>
            <td>{user.full_name || 'â€”'}</td>
            <td>{user.email}</td>
            <td><span class={`badge ${user.role || 'creator'}`}>{user.role || 'creator'}</span></td>
            <td><span class={`badge ${user.is_active ? 'active' : 'disabled'}`}>{user.is_active ? 'Active' : 'Disabled'}</span></td>
            <td>{new Date(user.created_at).toLocaleDateString()}</td>
          </tr>
        ))}
      </tbody>
    </table>
  ) : (
    <div class="panel">
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ‘¥</div>
        <div class="empty-state-title">No users yet</div>
        <p>Users will appear here once they sign up.</p>
      </div>
    </div>
  )}
</AdminLayout>
