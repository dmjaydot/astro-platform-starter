---
// src/pages/admin/users.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

// Auth from middleware
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Create admin client with service key for user management
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseServiceKey = import.meta.env.SUPABASE_SERVICE_KEY;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

// Use service key if available (required for admin operations)
const supabase = createClient(
  supabaseUrl,
  supabaseServiceKey || supabaseAnonKey,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

const hasServiceKey = !!supabaseServiceKey;

let actionMessage = '';
let actionError = '';

const action = Astro.url.searchParams.get('action');
const editUserId = Astro.url.searchParams.get('edit');

// Get user being edited
let editUser = null;
if (editUserId) {
  const { data } = await supabase.from('profiles').select('*').eq('id', editUserId).single();
  editUser = data;
}

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  // ============ CREATE USER (Master Key Only) ============
  if (formAction === 'create_user') {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can create users.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to create users.';
    } else {
      const email = (form.get('email') as string)?.trim();
      const password = form.get('password') as string;
      const fullName = (form.get('fullName') as string)?.trim();
      const role = (form.get('role') as string) || 'creator';

      if (!email || !password) {
        actionError = 'Email and password are required.';
      } else if (password.length < 8) {
        actionError = 'Password must be at least 8 characters.';
      } else {
        // Create auth user
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
          email,
          password,
          email_confirm: true, // Auto-confirm email
          user_metadata: { full_name: fullName },
        });

        if (authError) {
          actionError = authError.message;
        } else if (authData.user) {
          // Create profile
          const { error: profileError } = await supabase.from('profiles').upsert({
            id: authData.user.id,
            email,
            full_name: fullName,
            role,
            is_active: true,
            is_verified: true,
          });

          if (profileError) {
            actionError = `User created but profile failed: ${profileError.message}`;
          } else {
            return Astro.redirect('/admin/users?created=true');
          }
        }
      }
    }
  }

  // ============ RESET PASSWORD (Master Key Only) ============
  if (formAction === 'reset_password') {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can reset passwords.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to reset passwords.';
    } else {
      const userId = form.get('userId') as string;
      const newPassword = form.get('newPassword') as string;

      if (!newPassword || newPassword.length < 8) {
        actionError = 'Password must be at least 8 characters.';
      } else {
        const { error } = await supabase.auth.admin.updateUserById(userId, {
          password: newPassword,
        });

        if (error) {
          actionError = error.message;
        } else {
          actionMessage = 'Password reset successfully.';
        }
      }
    }
  }

  // ============ UPDATE USER ============
  if (formAction === 'update_user') {
    const userId = form.get('userId') as string;
    const fullName = (form.get('fullName') as string)?.trim();
    const role = form.get('role') as string;
    const isActive = form.get('isActive') === 'on';
    const isVerified = form.get('isVerified') === 'on';

    const { error } = await supabase.from('profiles').update({
      full_name: fullName,
      role,
      is_active: isActive,
      is_verified: isVerified,
    }).eq('id', userId);

    if (error) {
      actionError = error.message;
    } else {
      return Astro.redirect('/admin/users?updated=true');
    }
  }

  // ============ QUICK ACTIONS ============
  const userId = form.get('userId') as string;
  
  if (formAction === 'toggle_active' && userId) {
    const { data: user } = await supabase.from('profiles').select('is_active').eq('id', userId).single();
    const { error } = await supabase.from('profiles').update({ is_active: !user?.is_active }).eq('id', userId);
    if (error) actionError = error.message;
    else actionMessage = `User ${user?.is_active ? 'disabled' : 'enabled'} successfully.`;
  }

  if (formAction === 'set_role' && userId) {
    const newRole = form.get('newRole') as string;
    const { error } = await supabase.from('profiles').update({ role: newRole }).eq('id', userId);
    if (error) actionError = error.message;
    else actionMessage = `User role updated to ${newRole}.`;
  }

  if (formAction === 'delete_user' && userId) {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can delete users.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to delete users.';
    } else {
      // Delete profile first
      await supabase.from('profiles').delete().eq('id', userId);
      // Delete auth user
      const { error } = await supabase.auth.admin.deleteUser(userId);
      if (error) actionError = error.message;
      else actionMessage = 'User deleted permanently.';
    }
  }
}

// Success messages from redirects
if (Astro.url.searchParams.get('created')) actionMessage = 'User created successfully!';
if (Astro.url.searchParams.get('updated')) actionMessage = 'User updated successfully!';

// Fetch all users
const { data: users, error } = await supabase
  .from("profiles")
  .select("id, email, full_name, role, is_active, is_verified, avatar_url, bio, created_at")
  .order("created_at", { ascending: false });

// Stats
const totalUsers = users?.length || 0;
const activeUsers = users?.filter(u => u.is_active).length || 0;
const verifiedUsers = users?.filter(u => u.is_verified).length || 0;
const adminCount = users?.filter(u => u.role === 'admin').length || 0;
const modCount = users?.filter(u => u.role === 'moderator').length || 0;
const creatorCount = users?.filter(u => u.role === 'creator').length || 0;

// Filter
const filter = Astro.url.searchParams.get('filter') || 'all';
const searchQuery = Astro.url.searchParams.get('q')?.toLowerCase() || '';

const filteredUsers = users?.filter(user => {
  // Apply role/status filter
  let matchesFilter = true;
  if (filter === 'active') matchesFilter = user.is_active;
  else if (filter === 'inactive') matchesFilter = !user.is_active;
  else if (filter === 'verified') matchesFilter = user.is_verified;
  else if (filter === 'admin') matchesFilter = user.role === 'admin';
  else if (filter === 'moderator') matchesFilter = user.role === 'moderator';
  else if (filter === 'creator') matchesFilter = user.role === 'creator';

  // Apply search
  if (searchQuery) {
    const matchesSearch = 
      user.email?.toLowerCase().includes(searchQuery) ||
      user.full_name?.toLowerCase().includes(searchQuery);
    return matchesFilter && matchesSearch;
  }

  return matchesFilter;
}) || [];

const showForm = action === 'new' || editUserId;
---

<AdminLayout title="Users">
  {actionMessage && <div class="alert success">{actionMessage}</div>}
  {actionError && <div class="alert error">{actionError}</div>}
  {error && <div class="alert error">{error.message}</div>}

  {!hasServiceKey && isMasterKeySession && (
    <div class="alert warning">
      ‚ö†Ô∏è SUPABASE_SERVICE_KEY not configured. Password reset and user creation features are disabled.
      <a href="/admin/settings?section=debug">Check settings</a>
    </div>
  )}

  {showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>{editUser ? 'Edit User' : 'Create New User'}</h2>
        <a href="/admin/users" class="btn btn-secondary">‚Üê Back</a>
      </div>
      
      {action === 'new' ? (
        <!-- Create User Form -->
        <form method="POST" class="form">
          <input type="hidden" name="action" value="create_user" />
          
          {!isMasterKeySession && (
            <div class="alert warning">‚ö†Ô∏è Only master key sessions can create users. Log in with master key.</div>
          )}
          
          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" required placeholder="user@example.com" />
            </div>
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" name="fullName" placeholder="John Doe" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Password * <span class="hint">(min 8 characters)</span></label>
              <input type="password" name="password" required minlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div class="form-group">
              <label>Role</label>
              <select name="role">
                <option value="creator">Creator</option>
                <option value="moderator">Moderator</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled={!isMasterKeySession}>Create User</button>
            <a href="/admin/users" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      ) : editUser ? (
        <!-- Edit User Form -->
        <form method="POST" class="form">
          <input type="hidden" name="action" value="update_user" />
          <input type="hidden" name="userId" value={editUser.id} />
          
          <div class="user-header">
            <div class="user-avatar large">
              {editUser.avatar_url ? (
                <img src={editUser.avatar_url} alt={editUser.full_name || 'User'} />
              ) : (
                <span>{editUser.full_name?.charAt(0) || editUser.email?.charAt(0)?.toUpperCase() || '?'}</span>
              )}
            </div>
            <div>
              <div class="user-email-display">{editUser.email}</div>
              <div class="user-id">ID: {editUser.id}</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" name="fullName" value={editUser.full_name || ''} placeholder="John Doe" />
            </div>
            <div class="form-group">
              <label>Role</label>
              <select name="role">
                <option value="creator" selected={editUser.role === 'creator'}>Creator</option>
                <option value="moderator" selected={editUser.role === 'moderator'}>Moderator</option>
                <option value="admin" selected={editUser.role === 'admin'}>Admin</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" name="isActive" checked={editUser.is_active} />
                <span>Account Active</span>
              </label>
            </div>
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" name="isVerified" checked={editUser.is_verified} />
                <span>Email Verified</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/admin/users" class="btn btn-secondary">Cancel</a>
          </div>
        </form>

        <!-- Password Reset Section (Master Key Only) -->
        {isMasterKeySession && hasServiceKey && (
          <div class="password-reset-section">
            <h3>üîê Reset Password</h3>
            <p class="section-desc">Set a new password for this user. They will be able to log in immediately with the new password.</p>
            <form method="POST" class="inline-form">
              <input type="hidden" name="action" value="reset_password" />
              <input type="hidden" name="userId" value={editUser.id} />
              <input type="password" name="newPassword" required minlength="8" placeholder="New password (min 8 chars)" class="form-input" />
              <button type="submit" class="btn btn-warning">Reset Password</button>
            </form>
          </div>
        )}

        <!-- Danger Zone -->
        {isMasterKeySession && hasServiceKey && (
          <div class="danger-zone">
            <h3>‚ö†Ô∏è Danger Zone</h3>
            <p class="section-desc">Permanently delete this user and all associated data. This cannot be undone.</p>
            <form method="POST" onsubmit="return confirm('Are you ABSOLUTELY sure? This will permanently delete this user and cannot be undone.');">
              <input type="hidden" name="action" value="delete_user" />
              <input type="hidden" name="userId" value={editUser.id} />
              <button type="submit" class="btn btn-danger">Delete User Permanently</button>
            </form>
          </div>
        )}
      ) : null}
    </div>
  ) : (
    <>
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-content"><div class="stat-value">{totalUsers}</div><div class="stat-label">Total Users</div></div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-content"><div class="stat-value">{activeUsers}</div><div class="stat-label">Active</div></div></div>
        <div class="stat-card"><div class="stat-icon">üõ°Ô∏è</div><div class="stat-content"><div class="stat-value">{adminCount + modCount}</div><div class="stat-label">Staff</div></div></div>
        <div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-content"><div class="stat-value">{verifiedUsers}</div><div class="stat-label">Verified</div></div></div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="filter-tabs">
          <a href="/admin/users" class:list={["filter-tab", { active: filter === 'all' }]}>All ({totalUsers})</a>
          <a href="?filter=active" class:list={["filter-tab", { active: filter === 'active' }]}>Active</a>
          <a href="?filter=inactive" class:list={["filter-tab", { active: filter === 'inactive' }]}>Inactive</a>
          <a href="?filter=admin" class:list={["filter-tab", { active: filter === 'admin' }]}>Admins</a>
          <a href="?filter=moderator" class:list={["filter-tab", { active: filter === 'moderator' }]}>Mods</a>
          <a href="?filter=creator" class:list={["filter-tab", { active: filter === 'creator' }]}>Creators</a>
        </div>
        <div class="toolbar-actions">
          <form class="search-form" method="GET">
            {filter !== 'all' && <input type="hidden" name="filter" value={filter} />}
            <input type="text" name="q" placeholder="Search users..." value={searchQuery} class="search-input" />
          </form>
          {isMasterKeySession && (
            <a href="?action=new" class="btn btn-primary">+ New User</a>
          )}
        </div>
      </div>

      <!-- Users List -->
      <div class="panel">
        <div class="panel-header">
          <h2>{filter === 'all' ? 'All Users' : `${filter.charAt(0).toUpperCase() + filter.slice(1)} Users`}</h2>
          <span class="panel-count">{filteredUsers.length} users</span>
        </div>

        {filteredUsers.length > 0 ? (
          <div class="users-list">
            {filteredUsers.map(user => (
              <div class="user-card">
                <div class="user-main">
                  <div class="user-avatar">
                    {user.avatar_url ? (
                      <img src={user.avatar_url} alt={user.full_name || 'User'} />
                    ) : (
                      <span>{user.full_name?.charAt(0) || user.email?.charAt(0)?.toUpperCase() || '?'}</span>
                    )}
                    {user.is_verified && <div class="verified-badge" title="Verified">‚úì</div>}
                  </div>
                  <div class="user-info">
                    <div class="user-name">
                      {user.full_name || 'No name'}
                      {!user.is_active && <span class="inactive-tag">Disabled</span>}
                    </div>
                    <div class="user-email">{user.email}</div>
                  </div>
                </div>

                <div class="user-meta">
                  <span class={`role-badge ${user.role || 'creator'}`}>{user.role || 'creator'}</span>
                  <span class="user-date">Joined {new Date(user.created_at).toLocaleDateString()}</span>
                </div>

                <div class="user-actions">
                  <a href={`?edit=${user.id}`} class="btn btn-sm btn-secondary">‚úèÔ∏è Edit</a>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-trigger">Role ‚ñæ</button>
                    <div class="dropdown-menu">
                      <form method="POST">
                        <input type="hidden" name="userId" value={user.id} />
                        <input type="hidden" name="action" value="set_role" />
                        <button type="submit" name="newRole" value="admin" class="dropdown-item" disabled={user.role === 'admin'}>üëë Admin</button>
                      </form>
                      <form method="POST">
                        <input type="hidden" name="userId" value={user.id} />
                        <input type="hidden" name="action" value="set_role" />
                        <button type="submit" name="newRole" value="moderator" class="dropdown-item" disabled={user.role === 'moderator'}>üõ°Ô∏è Moderator</button>
                      </form>
                      <form method="POST">
                        <input type="hidden" name="userId" value={user.id} />
                        <input type="hidden" name="action" value="set_role" />
                        <button type="submit" name="newRole" value="creator" class="dropdown-item" disabled={user.role === 'creator'}>üé® Creator</button>
                      </form>
                    </div>
                  </div>
                  <form method="POST" class="inline">
                    <input type="hidden" name="userId" value={user.id} />
                    <button type="submit" name="action" value="toggle_active" class={`btn btn-sm ${user.is_active ? 'btn-warning' : 'btn-success'}`}>
                      {user.is_active ? 'üö´' : '‚úÖ'}
                    </button>
                  </form>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <div class="empty-state-title">No users found</div>
            <p>{searchQuery ? 'Try a different search term.' : 'No users match the selected filter.'}</p>
          </div>
        )}
      </div>
    </>
  )}

  <style>
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; padding: 1.25rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; }
    .stat-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.8125rem; color: #6b7280; }

    .toolbar { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .toolbar-actions { display: flex; gap: 0.75rem; align-items: center; }
    .filter-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .filter-tab { padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; color: #6b7280; font-size: 0.875rem; font-weight: 500; }
    .filter-tab:hover { background: #f3f4f6; color: #1a1a2e; }
    .filter-tab.active { background: #2563eb; color: white; }
    
    .search-form { display: flex; }
    .search-input { padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; width: 200px; }
    .search-input:focus { outline: none; border-color: #2563eb; }

    .panel { background: white; border-radius: 12px; overflow: hidden; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1rem; color: #1a1a2e; margin: 0; }
    .panel-count { font-size: 0.875rem; color: #6b7280; }

    .users-list { padding: 0; }
    .user-card { display: flex; align-items: center; gap: 1.5rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f0f0f0; }
    .user-card:last-child { border-bottom: none; }
    .user-card:hover { background: #f9fafb; }
    .user-main { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
    .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #2563eb; position: relative; flex-shrink: 0; }
    .user-avatar.large { width: 64px; height: 64px; font-size: 1.5rem; }
    .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .verified-badge { position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; background: #2563eb; border: 2px solid white; border-radius: 50%; color: white; font-size: 0.5rem; display: flex; align-items: center; justify-content: center; }
    .user-info { min-width: 0; }
    .user-name { font-weight: 600; color: #1a1a2e; display: flex; align-items: center; gap: 0.5rem; }
    .user-email { font-size: 0.875rem; color: #6b7280; }
    .user-email-display { font-size: 1rem; color: #374151; }
    .user-id { font-size: 0.75rem; color: #9ca3af; font-family: monospace; }
    .inactive-tag { font-size: 0.625rem; padding: 0.125rem 0.5rem; background: #fee2e2; color: #dc2626; border-radius: 4px; font-weight: 500; }
    .user-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; min-width: 100px; }
    .user-date { font-size: 0.75rem; color: #9ca3af; }
    .user-actions { display: flex; gap: 0.5rem; align-items: center; }
    
    .role-badge { font-size: 0.6875rem; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; text-transform: uppercase; }
    .role-badge.admin { background: #fee2e2; color: #dc2626; }
    .role-badge.moderator { background: #fef3c7; color: #d97706; }
    .role-badge.creator { background: #d1fae5; color: #059669; }

    .dropdown { position: relative; }
    .dropdown-trigger { cursor: pointer; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 150px; z-index: 50; display: none; }
    .dropdown:hover .dropdown-menu, .dropdown:focus-within .dropdown-menu { display: block; }
    .dropdown-item { display: block; width: 100%; padding: 0.5rem 1rem; text-align: left; border: none; background: none; font-size: 0.875rem; color: #374151; cursor: pointer; }
    .dropdown-item:hover { background: #f3f4f6; }
    .dropdown-item:disabled { opacity: 0.5; cursor: not-allowed; }

    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group .hint { font-weight: 400; color: #9ca3af; font-size: 0.75rem; }
    .form-group input, .form-group select { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2563eb; }
    .form-input { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; flex: 1; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
    
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .toggle-label input { width: 18px; height: 18px; }

    .user-header { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; margin-bottom: 0.5rem; }

    .password-reset-section, .danger-zone { padding: 1.5rem; border-top: 1px solid #e5e7eb; }
    .password-reset-section h3, .danger-zone h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .section-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
    .inline-form { display: flex; gap: 0.75rem; align-items: center; }
    .danger-zone { background: #fef2f2; }
    .danger-zone h3 { color: #dc2626; }

    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-success { background: #059669; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .inline { display: inline; }

    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    .alert.warning { background: #fef3c7; color: #92400e; }
    .alert a { color: inherit; text-decoration: underline; }

    .empty-state { text-align: center; padding: 4rem 2rem; color: #6b7280; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state-title { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }

    @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .user-card { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .user-meta { flex-direction: row; width: 100%; justify-content: space-between; }
      .user-actions { width: 100%; justify-content: flex-start; }
      .inline-form { flex-direction: column; }
      .inline-form .form-input { width: 100%; }
    }
  </style>
</AdminLayout>
