---
// src/pages/admin/review.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

let successMessage = '';
let errorMessage = '';
let tableExists = true;

const action = Astro.url.searchParams.get('action');

// Get users and campaigns for dropdowns
const { data: creators } = await supabase
  .from('profiles')
  .select('id, full_name, email')
  .order('full_name', { ascending: true, nullsFirst: false });

const { data: campaigns } = await supabase
  .from('campaigns')
  .select('id, title')
  .eq('status', 'active')
  .order('title');

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  if (formAction === 'create') {
    const title = (form.get('title') as string)?.trim();
    
    if (!title) {
      errorMessage = 'Title/description is required.';
    } else {
      // Handle empty strings as null for foreign keys
      const creatorIdRaw = form.get('creatorId') as string;
      const campaignIdRaw = form.get('campaignId') as string;
      const creatorId = creatorIdRaw && creatorIdRaw.trim() !== '' ? creatorIdRaw : null;
      const campaignId = campaignIdRaw && campaignIdRaw.trim() !== '' ? campaignIdRaw : null;
      
      const mediaUrl = (form.get('mediaUrl') as string)?.trim() || null;
      const mediaType = (form.get('mediaType') as string) || 'image';
      const caption = (form.get('caption') as string)?.trim() || null;

      const { error } = await supabase.from('posts').insert({
        title,
        creator_id: creatorId,
        campaign_id: campaignId,
        media_url: mediaUrl,
        media_type: mediaType,
        caption,
        status: 'pending',
      });

      if (error) {
        if (error.code === '42P01') {
          errorMessage = 'Posts table not found. Please run the database migration.';
          tableExists = false;
        } else if (error.code === '23503') {
          errorMessage = 'Invalid creator or campaign selection.';
        } else {
          errorMessage = error.message;
        }
      } else {
        return Astro.redirect('/admin/review?created=true');
      }
    }
  }

  if (formAction === 'approve' || formAction === 'reject' || formAction === 'revision') {
    const postId = form.get('postId') as string;
    const notes = (form.get('notes') as string)?.trim() || null;
    const statusMap: Record<string, string> = { 
      approve: 'approved', 
      reject: 'rejected', 
      revision: 'revision_requested' 
    };
    
    const { error } = await supabase.from('posts').update({
      status: statusMap[formAction],
      review_notes: notes,
      reviewed_at: new Date().toISOString(),
    }).eq('id', postId);

    if (error) {
      errorMessage = error.message;
    } else {
      const messages: Record<string, string> = {
        approve: 'Post approved successfully.',
        reject: 'Post rejected.',
        revision: 'Revision requested from creator.',
      };
      successMessage = messages[formAction];
    }
  }

  if (formAction === 'delete') {
    const postId = form.get('postId') as string;
    const { error } = await supabase.from('posts').delete().eq('id', postId);
    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = 'Post deleted.';
    }
  }

  if (formAction === 'reset_to_pending') {
    const postId = form.get('postId') as string;
    const { error } = await supabase.from('posts').update({
      status: 'pending',
      review_notes: null,
      reviewed_at: null,
    }).eq('id', postId);
    if (error) errorMessage = error.message;
    else successMessage = 'Post reset to pending.';
  }
}

if (Astro.url.searchParams.get('created')) successMessage = 'Review task created!';

// Load pending posts - use simpler query to avoid relationship errors
const { data: pendingPosts, error: pendingError } = await supabase
  .from('posts')
  .select('*')
  .eq('status', 'pending')
  .order('created_at', { ascending: false });

if (pendingError && pendingError.code === '42P01') {
  tableExists = false;
  errorMessage = 'Posts table not found. Please run the database migration.';
}

// Enrich with creator and campaign data
const enrichedPending = [];
if (pendingPosts) {
  for (const post of pendingPosts) {
    let creatorData = null;
    let campaignData = null;
    
    if (post.creator_id) {
      const { data } = await supabase.from('profiles').select('full_name, email, avatar_url').eq('id', post.creator_id).single();
      creatorData = data;
    }
    if (post.campaign_id) {
      const { data } = await supabase.from('campaigns').select('title').eq('id', post.campaign_id).single();
      campaignData = data;
    }
    
    enrichedPending.push({ ...post, creator: creatorData, campaign: campaignData });
  }
}

// Load reviewed posts (history)
const { data: reviewedPosts } = await supabase
  .from('posts')
  .select('*')
  .neq('status', 'pending')
  .order('reviewed_at', { ascending: false })
  .limit(20);

// Enrich reviewed posts
const enrichedReviewed = [];
if (reviewedPosts) {
  for (const post of reviewedPosts) {
    let creatorData = null;
    let campaignData = null;
    
    if (post.creator_id) {
      const { data } = await supabase.from('profiles').select('full_name, email').eq('id', post.creator_id).single();
      creatorData = data;
    }
    if (post.campaign_id) {
      const { data } = await supabase.from('campaigns').select('title').eq('id', post.campaign_id).single();
      campaignData = data;
    }
    
    enrichedReviewed.push({ ...post, creator: creatorData, campaign: campaignData });
  }
}

const view = Astro.url.searchParams.get('view') || 'pending';

const stats = {
  pending: enrichedPending?.length || 0,
  approved: enrichedReviewed?.filter(p => p.status === 'approved').length || 0,
  rejected: enrichedReviewed?.filter(p => p.status === 'rejected').length || 0,
};

const showForm = action === 'new';
---

<AdminLayout title="Review Queue">
  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}

  {!tableExists ? (
    <div class="empty">
      <span>‚ö†Ô∏è</span>
      <h3>Posts Table Not Found</h3>
      <p>Please run the database migration to create the posts table.</p>
    </div>
  ) : showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>Create New Review Task</h2>
        <a href="/admin/review" class="btn btn-secondary">‚Üê Back</a>
      </div>
      <form method="POST" class="form">
        <input type="hidden" name="action" value="create" />
        
        <div class="form-group">
          <label>Title / Description *</label>
          <input type="text" name="title" required placeholder="Product Review Video" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Creator <span class="hint">(optional)</span></label>
            <select name="creatorId">
              <option value="">-- No Creator Assigned --</option>
              {creators?.map(c => (
                <option value={c.id}>{c.full_name || c.email || 'Unknown'}</option>
              ))}
            </select>
          </div>
          <div class="form-group">
            <label>Campaign <span class="hint">(optional)</span></label>
            <select name="campaignId">
              <option value="">-- No Campaign --</option>
              {campaigns?.map(c => (
                <option value={c.id}>{c.title}</option>
              ))}
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Media URL <span class="hint">(optional)</span></label>
            <input type="url" name="mediaUrl" placeholder="https://example.com/image.jpg" />
          </div>
          <div class="form-group">
            <label>Media Type</label>
            <select name="mediaType">
              <option value="image">Image</option>
              <option value="video">Video</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Caption / Notes <span class="hint">(optional)</span></label>
          <textarea name="caption" rows="3" placeholder="Additional details about this content..."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create Task</button>
          <a href="/admin/review" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  ) : (
    <>
      <div class="stats-grid">
        <div class={`stat-card ${stats.pending > 0 ? 'urgent' : ''}`}><div class="stat-icon">‚è≥</div><div><div class="stat-value">{stats.pending}</div><div class="stat-label">Pending</div></div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div><div class="stat-value">{stats.approved}</div><div class="stat-label">Approved (recent)</div></div></div>
        <div class="stat-card"><div class="stat-icon">‚ùå</div><div><div class="stat-value">{stats.rejected}</div><div class="stat-label">Rejected (recent)</div></div></div>
      </div>

      <div class="toolbar">
        <div class="tabs">
          <a href="?view=pending" class:list={["tab", { active: view === 'pending' }]}>Pending ({stats.pending})</a>
          <a href="?view=history" class:list={["tab", { active: view === 'history' }]}>History</a>
        </div>
        <a href="?action=new" class="btn btn-primary">+ New Task</a>
      </div>

      {view === 'pending' ? (
        enrichedPending && enrichedPending.length > 0 ? (
          <div class="grid">
            {enrichedPending.map(post => (
              <div class="review-card">
                <div class="media-preview">
                  {post.media_url ? (
                    post.media_type === 'video' ? (
                      <video src={post.media_url} controls preload="metadata"></video>
                    ) : (
                      <img src={post.media_url} alt={post.title || 'Media'} loading="lazy" />
                    )
                  ) : (
                    <div class="no-media">üìÑ</div>
                  )}
                </div>
                
                <div class="review-content">
                  <div class="review-header">
                    <h3>{post.title || 'Untitled'}</h3>
                    <span class="badge pending">Pending</span>
                  </div>
                  
                  <div class="review-meta">
                    {post.creator && (
                      <div class="creator">
                        <div class="avatar">{(post.creator.full_name || post.creator.email || '?').charAt(0).toUpperCase()}</div>
                        <div>
                          <div class="creator-name">{post.creator.full_name || 'Unknown'}</div>
                          <div class="creator-email">{post.creator.email || ''}</div>
                        </div>
                      </div>
                    )}
                    {!post.creator && <div class="no-creator">No creator assigned</div>}
                    {post.campaign && <div class="campaign">üì¢ {post.campaign.title}</div>}
                  </div>
                  
                  {post.caption && <p class="caption">{post.caption}</p>}
                  
                  <form method="POST" class="review-form">
                    <input type="hidden" name="postId" value={post.id} />
                    <textarea name="notes" placeholder="Review notes (optional)..." rows="2"></textarea>
                    <div class="review-actions">
                      <button name="action" value="approve" class="btn btn-success">‚úì Approve</button>
                      <button name="action" value="revision" class="btn btn-warning">‚Üª Revision</button>
                      <button name="action" value="reject" class="btn btn-danger">‚úï Reject</button>
                    </div>
                    <div class="secondary-actions">
                      <button name="action" value="delete" class="btn btn-sm btn-secondary" onclick="return confirm('Delete this post permanently?');">üóëÔ∏è Delete</button>
                    </div>
                  </form>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty">
            <span>üéâ</span>
            <h3>All caught up!</h3>
            <p>No pending posts to review.</p>
            <a href="?action=new" class="btn btn-primary">Create New Task</a>
          </div>
        )
      ) : (
        enrichedReviewed && enrichedReviewed.length > 0 ? (
          <div class="panel">
            <table class="table">
              <thead>
                <tr>
                  <th>Post</th>
                  <th>Creator</th>
                  <th>Campaign</th>
                  <th>Status</th>
                  <th>Reviewed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {enrichedReviewed.map(post => (
                  <tr>
                    <td><strong>{post.title || 'Untitled'}</strong></td>
                    <td>{post.creator?.full_name || post.creator?.email || '‚Äî'}</td>
                    <td>{post.campaign?.title || '‚Äî'}</td>
                    <td><span class={`badge ${post.status}`}>{post.status?.replace('_', ' ')}</span></td>
                    <td>{post.reviewed_at ? new Date(post.reviewed_at).toLocaleDateString() : '‚Äî'}</td>
                    <td>
                      <form method="POST" class="inline">
                        <input type="hidden" name="postId" value={post.id} />
                        <button name="action" value="reset_to_pending" class="btn btn-sm btn-secondary" title="Return to pending">‚Üª</button>
                        <button name="action" value="delete" class="btn btn-sm btn-danger" onclick="return confirm('Delete?');" title="Delete">üóëÔ∏è</button>
                      </form>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="empty">
            <span>üìã</span>
            <p>No review history yet.</p>
          </div>
        )
      )}
    </>
  )}

  <style>
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; padding: 1.25rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; }
    .stat-card.urgent { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; }
    .stat-icon { font-size: 1.5rem; width: 44px; height: 44px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.8125rem; color: #6b7280; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background: white; padding: 1rem; border-radius: 12px; flex-wrap: wrap; gap: 1rem; }
    .tabs { display: flex; gap: 0.5rem; }
    .tab { padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; color: #6b7280; font-weight: 500; }
    .tab:hover { background: #f3f4f6; }
    .tab.active { background: #2563eb; color: white; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
    .review-card { background: white; border-radius: 12px; overflow: hidden; }
    .media-preview { height: 180px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .media-preview img, .media-preview video { width: 100%; height: 100%; object-fit: cover; }
    .no-media { font-size: 3rem; color: #d1d5db; }
    .review-content { padding: 1.25rem; }
    .review-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; gap: 0.5rem; }
    .review-header h3 { font-size: 1rem; color: #1a1a2e; word-break: break-word; }
    .badge { font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    .badge.pending { background: #fef3c7; color: #d97706; }
    .badge.approved { background: #d1fae5; color: #059669; }
    .badge.rejected { background: #fee2e2; color: #dc2626; }
    .badge.revision_requested { background: #dbeafe; color: #2563eb; }
    .review-meta { margin-bottom: 1rem; }
    .creator { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.5rem; }
    .avatar { width: 36px; height: 36px; background: linear-gradient(135deg, #dbeafe, #c7d2fe); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #2563eb; flex-shrink: 0; }
    .creator-name { font-weight: 600; font-size: 0.875rem; color: #1a1a2e; }
    .creator-email { font-size: 0.75rem; color: #6b7280; }
    .no-creator { font-size: 0.8125rem; color: #9ca3af; font-style: italic; margin-bottom: 0.5rem; }
    .campaign { font-size: 0.8125rem; color: #6b7280; }
    .caption { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; line-height: 1.5; }
    .review-form textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; resize: none; margin-bottom: 0.75rem; font-family: inherit; }
    .review-form textarea:focus { outline: none; border-color: #2563eb; }
    .review-actions { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
    .secondary-actions { border-top: 1px solid #e5e7eb; padding-top: 0.75rem; }
    
    .panel { background: white; border-radius: 12px; overflow: hidden; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1.125rem; color: #1a1a2e; margin: 0; }
    
    .table { width: 100%; border-collapse: collapse; }
    .table th { text-align: left; padding: 1rem; background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; }
    .table td { padding: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.875rem; }
    .table .inline { display: flex; gap: 0.25rem; }
    
    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group .hint { font-weight: 400; color: #9ca3af; font-size: 0.75rem; }
    .form-group input, .form-group select, .form-group textarea { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
    
    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-success { background: #059669; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .inline { display: inline; }
    
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    
    .empty { text-align: center; padding: 4rem 2rem; background: white; border-radius: 12px; }
    .empty span { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty h3 { color: #374151; margin-bottom: 0.5rem; }
    .empty p { color: #6b7280; margin-bottom: 1rem; }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .table { display: block; overflow-x: auto; }
      .review-actions { flex-wrap: wrap; }
    }
  </style>
</AdminLayout>
