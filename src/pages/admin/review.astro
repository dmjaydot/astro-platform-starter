---
// src/pages/admin/review.astro
export const prerender = false;

import { supabase } from '../../lib/supabase';

// --------------------------------------------------
// Auth & role data (from middleware)
// --------------------------------------------------
const session = Astro.locals.session;
const profile = Astro.locals.profile;
const isAdmin = Astro.locals.isAdmin;
const isModerator = Astro.locals.isModerator;

// Safety fallback (middleware should already enforce this)
if (!session || (!isAdmin && !isModerator)) {
  return Astro.redirect('/unauthorized');
}

// --------------------------------------------------
// Handle review action
// --------------------------------------------------
let actionMessage = '';
let actionError = '';

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const postId = form.get('postId') as string;
  const action = form.get('action') as string;
  const notes = form.get('notes') as string;

  if (postId && action) {
    let newStatus = 'pending';
    if (action === 'approve') newStatus = 'approved';
    else if (action === 'reject') newStatus = 'rejected';
    else if (action === 'revision') newStatus = 'revision_requested';

    const { error } = await supabase
      .from('posts')
      .update({
        status: newStatus,
        reviewed_by: session.user.id,
        reviewed_at: new Date().toISOString(),
        review_notes: notes || null,
      })
      .eq('id', postId);

    if (error) {
      actionError = `Failed to update: ${error.message}`;
    } else {
      actionMessage =
        `Post ${
          action === 'approve'
            ? 'approved'
            : action === 'reject'
            ? 'rejected'
            : 'sent for revision'
        }!`;
    }
  }
}

// --------------------------------------------------
// Fetch pending posts
// --------------------------------------------------
const { data: pendingPosts } = await supabase
  .from('posts')
  .select(`
    *,
    profiles!creator_id(id, full_name, email, avatar_url),
    campaigns(id, title, slug)
  `)
  .eq('status', 'pending')
  .order('created_at', { ascending: true });

// --------------------------------------------------
// Fetch recently reviewed
// --------------------------------------------------
const { data: recentlyReviewed } = await supabase
  .from('posts')
  .select(`
    *,
    profiles!creator_id(full_name),
    campaigns(title)
  `)
  .neq('status', 'pending')
  .order('reviewed_at', { ascending: false })
  .limit(10);
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Queue - Admin - Banity</title>
  <!-- styles unchanged -->
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-logo">üõ°Ô∏è Admin</div>
      <nav
