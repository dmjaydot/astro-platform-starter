---
import { handleAdminLogin } from '../../lib/adminAuth.js';

export const prerender = false;

let errorMessage = '';
let redirectUrl = '';

if (Astro.request.method === 'POST') {
  const result = await handleAdminLogin({ request: Astro.request, cookies: Astro.cookies, masterKey: import.meta.env.ADMIN_MASTER_KEY });
  errorMessage = result.error || '';
  redirectUrl = result.redirect || '';
}

if (redirectUrl) {
  return Astro.redirect(redirectUrl);
}

const hasMasterKey = !!import.meta.env.ADMIN_MASTER_KEY;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Login</title>
</head>
<body>
  {errorMessage && <p style="color:red;">{errorMessage}</p>}

  {hasMasterKey && (
    <form method="POST">
      <input type="hidden" name="loginType" value="master_key" />
      <label>Master Key: <input type="password" name="masterKey" required /></label>
      <button type="submit">Sign In</button>
    </form>
  )}

  <form method="POST">
    <input type="hidden" name="loginType" value="supabase" />
    <label>Email: <input type="email" name="email" required /></label>
    <label>Password: <input type="password" name="password" required /></label>
    <button type="submit">Sign In</button>
  </form>
</body>
</html>
