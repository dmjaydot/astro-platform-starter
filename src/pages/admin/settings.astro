---
// src/pages/admin/settings.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

// Auth check
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Defaults
const defaults = {
  general: {
    siteName: 'Banity',
    tagline: 'Create Authentic Content. Get Paid.',
    description: 'Banity connects creators with brands for authentic UGC campaigns.',
    supportEmail: 'support@banity.com',
    contactEmail: 'hello@banity.com',
    timezone: 'America/Los_Angeles',
    registrationMode: 'waitlist', // 'open', 'waitlist', 'closed'
  },
  appearance: {
    primaryColor: '#2563eb',
    accentColor: '#059669',
    logoUrl: '',
    faviconUrl: '',
  },
  security: {
    requireEmailVerify: true,
    enableMfa: false,
    enableSignup: true,
    maintenanceMode: false,
  },
};

let successMessage = '';
let errorMessage = '';

// Handle POST
if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const action = form.get('action') as string;

  if (action === 'update_general') {
    const value = {
      siteName: form.get('siteName') || defaults.general.siteName,
      tagline: form.get('tagline') || defaults.general.tagline,
      description: form.get('description') || defaults.general.description,
      supportEmail: form.get('supportEmail') || defaults.general.supportEmail,
      contactEmail: form.get('contactEmail') || defaults.general.contactEmail,
      timezone: form.get('timezone') || defaults.general.timezone,
      registrationMode: form.get('registrationMode') || defaults.general.registrationMode,
    };

    const { error } = await supabase
      .from('site_settings')
      .upsert({ key: 'general', value, updated_at: new Date().toISOString() }, { onConflict: 'key' });

    if (error) errorMessage = error.message;
    else successMessage = 'General settings saved!';
  }

  if (action === 'update_appearance') {
    const value = {
      primaryColor: form.get('primaryColor') || defaults.appearance.primaryColor,
      accentColor: form.get('accentColor') || defaults.appearance.accentColor,
      logoUrl: form.get('logoUrl') || '',
      faviconUrl: form.get('faviconUrl') || '',
    };

    const { error } = await supabase
      .from('site_settings')
      .upsert({ key: 'appearance', value, updated_at: new Date().toISOString() }, { onConflict: 'key' });

    if (error) errorMessage = error.message;
    else successMessage = 'Appearance settings saved!';
  }

  if (action === 'update_security') {
    const value = {
      requireEmailVerify: form.get('requireEmailVerify') === 'on',
      enableMfa: form.get('enableMfa') === 'on',
      enableSignup: form.get('enableSignup') === 'on',
      maintenanceMode: form.get('maintenanceMode') === 'on',
    };

    const { error } = await supabase
      .from('site_settings')
      .upsert({ key: 'security', value, updated_at: new Date().toISOString() }, { onConflict: 'key' });

    if (error) errorMessage = error.message;
    else successMessage = 'Security settings saved!';
  }
}

// Load settings
const { data: rows, error: loadError } = await supabase.from('site_settings').select('*');

const settings: any = { general: { ...defaults.general }, appearance: { ...defaults.appearance }, security: { ...defaults.security } };
if (rows) {
  for (const row of rows) {
    if (settings[row.key]) {
      settings[row.key] = { ...settings[row.key], ...row.value };
    }
  }
}

const section = Astro.url.searchParams.get('section') || 'general';
---

<AdminLayout title="Settings">
  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}
  {loadError && <div class="alert error">Load error: {loadError.message}</div>}

  <div class="layout">
    <nav class="nav">
      <a href="?section=general" class:list={["nav-link", { active: section === 'general' }]}>‚öôÔ∏è General</a>
      <a href="?section=appearance" class:list={["nav-link", { active: section === 'appearance' }]}>üé® Appearance</a>
      <a href="?section=security" class:list={["nav-link", { active: section === 'security' }]}>üîí Security</a>
      <a href="?section=debug" class:list={["nav-link", { active: section === 'debug' }]}>üêõ Debug</a>
    </nav>

    <main class="main">
      {section === 'general' && (
        <div class="card">
          <h2>General Settings</h2>
          <form method="POST">
            <input type="hidden" name="action" value="update_general" />
            <label>Site Name<input type="text" name="siteName" value={settings.general.siteName} /></label>
            <label>Tagline<input type="text" name="tagline" value={settings.general.tagline} /></label>
            <label>Description<textarea name="description" rows="3">{settings.general.description}</textarea></label>
            <label>Support Email<input type="email" name="supportEmail" value={settings.general.supportEmail} /></label>
            <label>Contact Email<input type="email" name="contactEmail" value={settings.general.contactEmail} /></label>
            <label>Timezone
              <select name="timezone">
                <option value="America/New_York" selected={settings.general.timezone === 'America/New_York'}>Eastern</option>
                <option value="America/Chicago" selected={settings.general.timezone === 'America/Chicago'}>Central</option>
                <option value="America/Los_Angeles" selected={settings.general.timezone === 'America/Los_Angeles'}>Pacific</option>
                <option value="UTC" selected={settings.general.timezone === 'UTC'}>UTC</option>
              </select>
            </label>
            <label>Registration Mode
              <select name="registrationMode">
                <option value="open" selected={settings.general.registrationMode === 'open'}>üü¢ Open - Anyone can sign up</option>
                <option value="waitlist" selected={settings.general.registrationMode === 'waitlist'}>‚è≥ Waitlist - Require approval</option>
                <option value="closed" selected={settings.general.registrationMode === 'closed'}>üî¥ Closed - No new signups</option>
              </select>
              <span class="hint">Controls how new user signups are handled.</span>
            </label>
            <button type="submit">Save General Settings</button>
          </form>
        </div>
      )}

      {section === 'appearance' && (
        <div class="card">
          <h2>Appearance</h2>
          <form method="POST">
            <input type="hidden" name="action" value="update_appearance" />
            <label>Primary Color<input type="color" name="primaryColor" value={settings.appearance.primaryColor} /></label>
            <label>Accent Color<input type="color" name="accentColor" value={settings.appearance.accentColor} /></label>
            <label>Logo URL<input type="url" name="logoUrl" value={settings.appearance.logoUrl} placeholder="https://..." /></label>
            <label>Favicon URL<input type="url" name="faviconUrl" value={settings.appearance.faviconUrl} placeholder="https://..." /></label>
            <button type="submit">Save Appearance</button>
          </form>
        </div>
      )}

      {section === 'security' && (
        <div class="card">
          <h2>Security</h2>
          <form method="POST">
            <input type="hidden" name="action" value="update_security" />
            <label class="toggle"><input type="checkbox" name="requireEmailVerify" checked={settings.security.requireEmailVerify} /> Require Email Verification</label>
            <label class="toggle"><input type="checkbox" name="enableMfa" checked={settings.security.enableMfa} /> Enable 2FA</label>
            <label class="toggle"><input type="checkbox" name="enableSignup" checked={settings.security.enableSignup} /> Allow Signups</label>
            <label class="toggle warning"><input type="checkbox" name="maintenanceMode" checked={settings.security.maintenanceMode} /> ‚ö†Ô∏è Maintenance Mode</label>
            <button type="submit">Save Security Settings</button>
          </form>
        </div>
      )}

      {section === 'debug' && (
        <div class="card">
          <h2>Debug Info</h2>
          <h3>Database Contents:</h3>
          <pre>{JSON.stringify(rows, null, 2)}</pre>
          <h3>Parsed Settings:</h3>
          <pre>{JSON.stringify(settings, null, 2)}</pre>
          <h3>Environment:</h3>
          <ul>
            <li>SUPABASE_URL: {import.meta.env.SUPABASE_URL ? '‚úÖ' : '‚ùå'}</li>
            <li>SUPABASE_SERVICE_KEY: {import.meta.env.SUPABASE_SERVICE_KEY ? '‚úÖ' : '‚ùå'}</li>
            <li>Master Key Session: {isMasterKeySession ? '‚úÖ' : '‚ùå'}</li>
          </ul>
        </div>
      )}
    </main>
  </div>

  <style>
    .layout { display: grid; grid-template-columns: 180px 1fr; gap: 1.5rem; }
    .nav { background: white; border-radius: 12px; padding: 0.5rem; height: fit-content; }
    .nav-link { display: block; padding: 0.75rem; text-decoration: none; color: #6b7280; border-radius: 8px; }
    .nav-link:hover { background: #f3f4f6; }
    .nav-link.active { background: #dbeafe; color: #2563eb; font-weight: 600; }
    .card { background: white; border-radius: 12px; padding: 1.5rem; }
    .card h2 { margin: 0 0 1.5rem; font-size: 1.25rem; color: #1a1a2e; }
    .card h3 { margin: 1.5rem 0 0.5rem; font-size: 1rem; color: #374151; }
    .card pre { background: #1a1a2e; color: #10b981; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.75rem; }
    .card ul { font-size: 0.875rem; color: #6b7280; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    label { display: flex; flex-direction: column; gap: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #374151; }
    input[type="text"], input[type="email"], input[type="url"], textarea, select {
      padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #2563eb; }
    input[type="color"] { width: 60px; height: 40px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; }
    .toggle { flex-direction: row; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; }
    .toggle.warning { background: #fef3c7; }
    .toggle input { width: 20px; height: 20px; }
    button { padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    .hint { font-size: 0.75rem; color: #9ca3af; font-weight: 400; margin-top: 0.25rem; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    @media (max-width: 768px) { .layout { grid-template-columns: 1fr; } .nav { display: flex; gap: 0.5rem; overflow-x: auto; } }
  </style>
</AdminLayout>
