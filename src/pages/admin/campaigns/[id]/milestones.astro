---
// src/pages/admin/campaigns/[id]/milestones.astro
export const prerender = false;

import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { supabase } from "../../../../lib/supabase";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

const { id: campaignId } = Astro.params;

// Fetch campaign
const { data: campaign, error: campaignError } = await supabase
  .from('campaigns')
  .select('*')
  .eq('id', campaignId)
  .single();

if (!campaign) {
  return Astro.redirect('/admin/campaigns?error=not_found');
}

let successMessage = '';
let errorMessage = '';

const action = Astro.url.searchParams.get('action');
const editMilestoneId = Astro.url.searchParams.get('edit');

// Get milestone being edited
let editMilestone = null;
if (editMilestoneId) {
  const { data } = await supabase.from('campaign_milestones').select('*').eq('id', editMilestoneId).single();
  editMilestone = data;
}

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  if (formAction === 'create' || formAction === 'update') {
    const title = (form.get('title') as string)?.trim();
    const description = (form.get('description') as string)?.trim() || null;
    const dueDate = form.get('dueDate') as string || null;
    const paymentAmount = parseFloat(form.get('paymentAmount') as string) || 0;
    const orderIndex = parseInt(form.get('orderIndex') as string) || 0;

    if (!title) {
      errorMessage = 'Milestone title is required.';
    } else {
      const milestoneData = {
        campaign_id: campaignId,
        title,
        description,
        due_date: dueDate || null,
        payment_amount: paymentAmount,
        order_index: orderIndex,
      };

      if (formAction === 'update') {
        const milestoneId = form.get('milestoneId') as string;
        const { error } = await supabase.from('campaign_milestones').update(milestoneData).eq('id', milestoneId);
        if (error) errorMessage = error.message;
        else return Astro.redirect(`/admin/campaigns/${campaignId}/milestones?updated=true`);
      } else {
        const { error } = await supabase.from('campaign_milestones').insert(milestoneData);
        if (error) errorMessage = error.message;
        else return Astro.redirect(`/admin/campaigns/${campaignId}/milestones?created=true`);
      }
    }
  }

  if (formAction === 'delete') {
    const milestoneId = form.get('milestoneId') as string;
    const { error } = await supabase.from('campaign_milestones').delete().eq('id', milestoneId);
    if (error) errorMessage = error.message;
    else successMessage = 'Milestone deleted.';
  }

  if (formAction === 'update_status') {
    const milestoneId = form.get('milestoneId') as string;
    const newStatus = form.get('newStatus') as string;
    const { error } = await supabase.from('campaign_milestones').update({ status: newStatus }).eq('id', milestoneId);
    if (error) errorMessage = error.message;
    else successMessage = 'Milestone status updated.';
  }
}

if (Astro.url.searchParams.get('created')) successMessage = 'Milestone created!';
if (Astro.url.searchParams.get('updated')) successMessage = 'Milestone updated!';

// Fetch milestones
const { data: milestones, error: milestonesError } = await supabase
  .from('campaign_milestones')
  .select('*')
  .eq('campaign_id', campaignId)
  .order('order_index', { ascending: true });

// Fetch assigned creators
const { data: assignments } = await supabase
  .from('campaign_assignments')
  .select('*, profiles(id, full_name, email, avatar_url)')
  .eq('campaign_id', campaignId);

// Calculate totals
const totalMilestonePayment = milestones?.reduce((sum, m) => sum + (m.payment_amount || 0), 0) || 0;
const completedMilestones = milestones?.filter(m => m.status === 'approved').length || 0;

const showForm = action === 'new' || editMilestoneId;
---

<AdminLayout title={`Milestones - ${campaign.title}`}>
  <div class="page-header">
    <div class="breadcrumb">
      <a href="/admin/campaigns">Campaigns</a>
      <span>/</span>
      <a href={`/admin/campaigns?edit=${campaignId}`}>{campaign.title}</a>
      <span>/</span>
      <span>Milestones</span>
    </div>
    <h1>{campaign.title} - Milestones & Payments</h1>
  </div>

  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}
  {milestonesError && <div class="alert error">{milestonesError.message}</div>}

  {showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>{editMilestone ? 'Edit Milestone' : 'Add New Milestone'}</h2>
        <a href={`/admin/campaigns/${campaignId}/milestones`} class="btn btn-secondary">‚Üê Back</a>
      </div>
      <form method="POST" class="form">
        <input type="hidden" name="action" value={editMilestone ? 'update' : 'create'} />
        {editMilestone && <input type="hidden" name="milestoneId" value={editMilestone.id} />}

        <div class="form-group">
          <label>Milestone Title *</label>
          <input type="text" name="title" required placeholder="e.g., First Draft Submission" value={editMilestone?.title || ''} />
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3" placeholder="What needs to be delivered for this milestone?">{editMilestone?.description || ''}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" name="dueDate" value={editMilestone?.due_date?.split('T')[0] || ''} />
          </div>
          <div class="form-group">
            <label>Payment Amount ($)</label>
            <input type="number" name="paymentAmount" min="0" step="0.01" placeholder="100.00" value={editMilestone?.payment_amount || ''} />
          </div>
        </div>

        <div class="form-group">
          <label>Order (for sorting)</label>
          <input type="number" name="orderIndex" min="0" placeholder="0" value={editMilestone?.order_index || milestones?.length || 0} />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">{editMilestone ? 'Update Milestone' : 'Add Milestone'}</button>
          <a href={`/admin/campaigns/${campaignId}/milestones`} class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  ) : (
    <>
      <!-- Campaign Summary -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Campaign Budget</div>
          <div class="summary-value">${campaign.budget || 0}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Milestone Payments</div>
          <div class="summary-value">${totalMilestonePayment.toFixed(2)}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Milestones</div>
          <div class="summary-value">{completedMilestones} / {milestones?.length || 0}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Assigned Creators</div>
          <div class="summary-value">{assignments?.length || 0}</div>
        </div>
      </div>

      <!-- Milestones Timeline -->
      <div class="panel">
        <div class="panel-header">
          <h2>üìã Milestones Timeline</h2>
          <a href={`?action=new`} class="btn btn-primary">+ Add Milestone</a>
        </div>

        {milestones && milestones.length > 0 ? (
          <div class="milestones-timeline">
            {milestones.map((milestone, index) => (
              <div class={`milestone-item ${milestone.status}`}>
                <div class="milestone-marker">
                  {milestone.status === 'approved' ? '‚úì' : 
                   milestone.status === 'completed' ? '‚óã' :
                   milestone.status === 'in_progress' ? '‚óê' : 
                   milestone.status === 'rejected' ? '‚úï' : (index + 1)}
                </div>
                <div class="milestone-content">
                  <div class="milestone-header">
                    <h3>{milestone.title}</h3>
                    <span class={`status-badge ${milestone.status}`}>{milestone.status.replace('_', ' ')}</span>
                  </div>
                  {milestone.description && <p class="milestone-desc">{milestone.description}</p>}
                  <div class="milestone-meta">
                    {milestone.due_date && (
                      <span class="meta-item">
                        üìÖ Due: {new Date(milestone.due_date).toLocaleDateString()}
                        {new Date(milestone.due_date) < new Date() && milestone.status !== 'approved' && (
                          <span class="overdue">Overdue</span>
                        )}
                      </span>
                    )}
                    {milestone.payment_amount > 0 && (
                      <span class="meta-item">üí∞ ${milestone.payment_amount}</span>
                    )}
                  </div>
                  <div class="milestone-actions">
                    <div class="status-buttons">
                      <form method="POST" class="inline">
                        <input type="hidden" name="milestoneId" value={milestone.id} />
                        <input type="hidden" name="action" value="update_status" />
                        <button name="newStatus" value="pending" class:list={["status-btn", { active: milestone.status === 'pending' }]} title="Pending">‚è≥</button>
                        <button name="newStatus" value="in_progress" class:list={["status-btn", { active: milestone.status === 'in_progress' }]} title="In Progress">üîÑ</button>
                        <button name="newStatus" value="completed" class:list={["status-btn", { active: milestone.status === 'completed' }]} title="Completed">üì§</button>
                        <button name="newStatus" value="approved" class:list={["status-btn", { active: milestone.status === 'approved' }]} title="Approved">‚úÖ</button>
                        <button name="newStatus" value="rejected" class:list={["status-btn", { active: milestone.status === 'rejected' }]} title="Rejected">‚ùå</button>
                      </form>
                    </div>
                    <div class="action-buttons">
                      <a href={`?edit=${milestone.id}`} class="btn btn-sm btn-secondary">Edit</a>
                      <form method="POST" class="inline" onsubmit="return confirm('Delete this milestone?');">
                        <input type="hidden" name="milestoneId" value={milestone.id} />
                        <button name="action" value="delete" class="btn btn-sm btn-danger">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <span>üìã</span>
            <h3>No milestones yet</h3>
            <p>Add milestones to track deliverables and payments for this campaign.</p>
            <a href="?action=new" class="btn btn-primary">Add First Milestone</a>
          </div>
        )}
      </div>

      <!-- Assigned Creators -->
      <div class="panel">
        <div class="panel-header">
          <h2>üë• Assigned Creators</h2>
        </div>
        {assignments && assignments.length > 0 ? (
          <div class="creators-list">
            {assignments.map(a => (
              <div class="creator-row">
                <div class="creator-avatar">
                  {a.profiles?.avatar_url ? (
                    <img src={a.profiles.avatar_url} alt={a.profiles.full_name} />
                  ) : (
                    <span>{a.profiles?.full_name?.charAt(0) || '?'}</span>
                  )}
                </div>
                <div class="creator-info">
                  <div class="creator-name">{a.profiles?.full_name || 'Unknown'}</div>
                  <div class="creator-email">{a.profiles?.email}</div>
                </div>
                <span class={`status-badge ${a.status}`}>{a.status}</span>
                <span class="assigned-date">Assigned {new Date(a.assigned_at).toLocaleDateString()}</span>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state small">
            <p>No creators assigned to this campaign yet.</p>
          </div>
        )}
      </div>
    </>
  )}

  <style>
    .page-header { margin-bottom: 1.5rem; }
    .breadcrumb { display: flex; gap: 0.5rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
    .breadcrumb a { color: #2563eb; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .page-header h1 { font-size: 1.5rem; color: #1a1a2e; margin: 0; }

    .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-card { background: white; padding: 1.25rem; border-radius: 12px; text-align: center; }
    .summary-label { font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem; }
    .summary-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }

    .panel { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1rem; color: #1a1a2e; margin: 0; }

    .milestones-timeline { padding: 1.5rem; }
    .milestone-item { display: flex; gap: 1rem; padding-bottom: 1.5rem; border-left: 2px solid #e5e7eb; margin-left: 1rem; padding-left: 1.5rem; position: relative; }
    .milestone-item:last-child { border-left-color: transparent; padding-bottom: 0; }
    .milestone-item.approved { border-left-color: #10b981; }
    .milestone-item.in_progress { border-left-color: #f59e0b; }
    .milestone-marker { position: absolute; left: -0.75rem; top: 0; width: 1.5rem; height: 1.5rem; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #6b7280; }
    .milestone-item.approved .milestone-marker { background: #10b981; color: white; }
    .milestone-item.in_progress .milestone-marker { background: #f59e0b; color: white; }
    .milestone-item.rejected .milestone-marker { background: #ef4444; color: white; }
    .milestone-content { flex: 1; }
    .milestone-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 0.5rem; }
    .milestone-header h3 { font-size: 1rem; color: #1a1a2e; margin: 0; }
    .milestone-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; }
    .milestone-meta { display: flex; gap: 1.5rem; font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .meta-item { display: flex; align-items: center; gap: 0.25rem; }
    .overdue { color: #ef4444; font-weight: 600; margin-left: 0.5rem; }
    .milestone-actions { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
    .status-buttons { display: flex; gap: 0.25rem; }
    .status-btn { width: 32px; height: 32px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; }
    .status-btn:hover { background: #f3f4f6; }
    .status-btn.active { border-color: #2563eb; background: #dbeafe; }
    .action-buttons { display: flex; gap: 0.5rem; }

    .status-badge { font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; text-transform: uppercase; }
    .status-badge.pending { background: #f3f4f6; color: #6b7280; }
    .status-badge.in_progress { background: #fef3c7; color: #d97706; }
    .status-badge.completed { background: #dbeafe; color: #2563eb; }
    .status-badge.approved { background: #d1fae5; color: #059669; }
    .status-badge.rejected { background: #fee2e2; color: #dc2626; }
    .status-badge.invited { background: #e0e7ff; color: #4f46e5; }
    .status-badge.accepted { background: #d1fae5; color: #059669; }

    .creators-list { padding: 0; }
    .creator-row { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; border-bottom: 1px solid #f0f0f0; }
    .creator-row:last-child { border-bottom: none; }
    .creator-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #dbeafe, #c7d2fe); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #2563eb; overflow: hidden; }
    .creator-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .creator-info { flex: 1; }
    .creator-name { font-weight: 600; color: #1a1a2e; }
    .creator-email { font-size: 0.8125rem; color: #6b7280; }
    .assigned-date { font-size: 0.75rem; color: #9ca3af; }

    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group input, .form-group select, .form-group textarea { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }

    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-danger { background: #dc2626; color: white; }
    .inline { display: inline; }

    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }

    .empty-state { text-align: center; padding: 3rem 2rem; color: #6b7280; }
    .empty-state span { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty-state h3 { color: #374151; margin-bottom: 0.5rem; }
    .empty-state p { margin-bottom: 1rem; }
    .empty-state.small { padding: 2rem; }
    .empty-state.small span { display: none; }

    @media (max-width: 768px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .form-row { grid-template-columns: 1fr; }
      .milestone-actions { flex-direction: column; align-items: flex-start; }
      .creator-row { flex-wrap: wrap; }
    }
  </style>
</AdminLayout>
