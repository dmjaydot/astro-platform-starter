---
// src/pages/admin/communities.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

let successMessage = '';
let errorMessage = '';
const action = Astro.url.searchParams.get('action');
const editId = Astro.url.searchParams.get('edit');

// Get community being edited
let editCommunity = null;
if (editId) {
  const { data } = await supabase.from('communities').select('*').eq('id', editId).single();
  editCommunity = data;
}

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  if (formAction === 'create' || formAction === 'update') {
    const name = (form.get('name') as string)?.trim();
    
    if (!name) {
      errorMessage = 'Community name is required.';
    } else {
      let slug = (form.get('slug') as string)?.trim();
      if (!slug) {
        slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      }
      
      const description = (form.get('description') as string)?.trim() || null;

      const communityData = { name, slug, description };

      if (formAction === 'update') {
        const communityId = form.get('communityId') as string;
        const { error } = await supabase.from('communities').update(communityData).eq('id', communityId);
        if (error) {
          errorMessage = error.code === '23505' ? 'A community with this slug already exists.' : error.message;
        } else {
          return Astro.redirect('/admin/communities?updated=true');
        }
      } else {
        const { error } = await supabase.from('communities').insert(communityData);
        if (error) {
          errorMessage = error.code === '23505' ? 'A community with this slug already exists.' : error.message;
        } else {
          return Astro.redirect('/admin/communities?created=true');
        }
      }
    }
  }

  if (formAction === 'delete') {
    const communityId = form.get('communityId') as string;
    
    // Check for related members/posts (adjust based on your schema)
    // For now, just try to delete and show error if FK fails
    const { error } = await supabase.from('communities').delete().eq('id', communityId);
    if (error) {
      if (error.code === '23503') {
        errorMessage = 'Cannot delete: This community has related data. Remove all members and posts first.';
      } else {
        errorMessage = error.message;
      }
    } else {
      successMessage = 'Community deleted.';
    }
  }
}

if (Astro.url.searchParams.get('created')) successMessage = 'Community created successfully!';
if (Astro.url.searchParams.get('updated')) successMessage = 'Community updated successfully!';

// Load communities
const { data: communities, error: loadError } = await supabase.from('communities').select('*').order('created_at', { ascending: false });

if (loadError && loadError.code === '42P01') {
  errorMessage = 'Communities table not found. Please run the database migration.';
}

const showForm = action === 'new' || editId;
---

<AdminLayout title="Communities">
  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}

  {showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>{editCommunity ? 'Edit Community' : 'Create New Community'}</h2>
        <a href="/admin/communities" class="btn btn-secondary">‚Üê Back</a>
      </div>
      <form method="POST" class="form">
        <input type="hidden" name="action" value={editCommunity ? 'update' : 'create'} />
        {editCommunity && <input type="hidden" name="communityId" value={editCommunity.id} />}
        
        <div class="form-row">
          <div class="form-group">
            <label>Community Name *</label>
            <input type="text" name="name" required placeholder="Fashion Creators" value={editCommunity?.name || ''} />
          </div>
          <div class="form-group">
            <label>Slug <span class="hint">(auto-generated if empty)</span></label>
            <input type="text" name="slug" placeholder="fashion-creators" value={editCommunity?.slug || ''} />
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="4" placeholder="What is this community about?">{editCommunity?.description || ''}</textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">{editCommunity ? 'Update Community' : 'Create Community'}</button>
          <a href="/admin/communities" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  ) : (
    <>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üí¨</div>
          <div>
            <div class="stat-value">{communities?.length || 0}</div>
            <div class="stat-label">Total Communities</div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <h2>All Communities</h2>
        <a href="?action=new" class="btn btn-primary">+ New Community</a>
      </div>

      {communities && communities.length > 0 ? (
        <div class="grid">
          {communities.map(c => (
            <div class="card">
              <div class="card-header">
                <div class="community-icon">üí¨</div>
                <div>
                  <h3>{c.name}</h3>
                  <span class="slug">/{c.slug}</span>
                </div>
              </div>
              {c.description && <p class="card-desc">{c.description}</p>}
              <div class="card-meta">
                <span>Created {new Date(c.created_at).toLocaleDateString()}</span>
              </div>
              <div class="card-actions">
                <a href={`?edit=${c.id}`} class="btn btn-sm btn-secondary">‚úèÔ∏è Edit</a>
                <a href={`/community/${c.slug}`} class="btn btn-sm btn-secondary" target="_blank">View ‚Üí</a>
                <form method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this community? This cannot be undone.');">
                  <input type="hidden" name="communityId" value={c.id} />
                  <button name="action" value="delete" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                </form>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="empty">
          <span>üí¨</span>
          <p>No communities yet</p>
          <a href="?action=new" class="btn btn-primary">Create First Community</a>
        </div>
      )}
    </>
  )}

  <style>
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; padding: 1.25rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; }
    .stat-icon { font-size: 1.5rem; width: 44px; height: 44px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.8125rem; color: #6b7280; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background: white; padding: 1rem 1.25rem; border-radius: 12px; }
    .toolbar h2 { font-size: 1rem; color: #1a1a2e; margin: 0; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
    .card { background: white; border-radius: 12px; padding: 1.25rem; }
    .card-header { display: flex; gap: 1rem; align-items: center; margin-bottom: 0.75rem; }
    .community-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #dbeafe, #c7d2fe); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
    .card-header h3 { font-size: 1rem; color: #1a1a2e; margin-bottom: 0.125rem; }
    .slug { font-size: 0.75rem; color: #9ca3af; font-family: monospace; }
    .card-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; line-height: 1.5; }
    .card-meta { font-size: 0.8125rem; color: #9ca3af; margin-bottom: 1rem; }
    .card-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .inline { display: inline; }
    
    .panel { background: white; border-radius: 12px; overflow: hidden; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1.125rem; color: #1a1a2e; margin: 0; }
    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group .hint { font-weight: 400; color: #9ca3af; font-size: 0.75rem; }
    .form-group input, .form-group textarea { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
    
    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-danger { background: #dc2626; color: white; }
    
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    
    .empty { text-align: center; padding: 4rem 2rem; background: white; border-radius: 12px; }
    .empty span { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty p { color: #6b7280; margin-bottom: 1rem; }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</AdminLayout>
